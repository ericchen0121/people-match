nflTeams = [ 
  'TEN',
  'BUF',
  'MIA',
  'NYJ',
  'NE',
  'CIN',
  'CLE',
  'BAL',
  'PIT',
  'IND',
  'JAC',
  'HOU',
  'DEN',
  'SD',
  'KC',
  'OAK',
  'DAL',
  'PHI',
  'NYG',
  'WAS',
  'CHI',
  'DET',
  'GB',
  'MIN',
  'TB',
  'ATL',
  'CAR',
  'NO',
  'SF',
  'ARI',
  'STL',
  'SEA'
]



# TODO: 2014 Playoff Teams, Replace for 2015!
playoffTeams = ['NE', 'SEA', 'GB', 'IND'] 

nbaTeams =  [
            {
                "id": "583ec8d4-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Wizards",
                "market": "Washington",
                "alias": "WAS"
            }, {
                "id": "583ec97e-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Hornets",
                "market": "Charlotte",
                "alias": "CHA"
            }, {
                "id": "583ecb8f-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Hawks",
                "market": "Atlanta",
                "alias": "ATL"
            }, {
                "id": "583ecea6-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Heat",
                "market": "Miami",
                "alias": "MIA"
            }, {
                "id": "583ed157-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Magic",
                "market": "Orlando",
                "alias": "ORL"
            }, {
                "id": "583ec70e-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Knicks",
                "market": "New York",
                "alias": "NYK"
            }, {
                "id": "583ec87d-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "76ers",
                "market": "Philadelphia",
                "alias": "PHI"
            }, {
                "id": "583ec9d6-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Nets",
                "market": "Brooklyn",
                "alias": "BKN"
            }, {
                "id": "583eccfa-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Celtics",
                "market": "Boston",
                "alias": "BOS"
            }, {
                "id": "583ecda6-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Raptors",
                "market": "Toronto",
                "alias": "TOR"
            }, {
                "id": "583ec5fd-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Bulls",
                "market": "Chicago",
                "alias": "CHI"
            }, {
                "id": "583ec773-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Cavaliers",
                "market": "Cleveland",
                "alias": "CLE"
            }, {
                "id": "583ec7cd-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Pacers",
                "market": "Indiana",
                "alias": "IND"
            }, {
                "id": "583ec928-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Pistons",
                "market": "Detroit",
                "alias": "DET"
            }, {
                "id": "583ecefd-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Bucks",
                "market": "Milwaukee",
                "alias": "MIL"
            }, {
                "id": "583eca2f-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Timberwolves",
                "market": "Minnesota",
                "alias": "MIN"
            }, {
                "id": "583ece50-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Jazz",
                "market": "Utah",
                "alias": "UTA"
            }, {
                "id": "583ecfff-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Thunder",
                "market": "Oklahoma City",
                "alias": "OKC"
            }, {
                "id": "583ed056-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Trail Blazers",
                "market": "Portland",
                "alias": "POR"
            }, {
                "id": "583ed102-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Nuggets",
                "market": "Denver",
                "alias": "DEN"
            }, {
                "id": "583eca88-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Grizzlies",
                "market": "Memphis",
                "alias": "MEM"
            }, {
                "id": "583ecb3a-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Rockets",
                "market": "Houston",
                "alias": "HOU"
            }, {
                "id": "583ecc9a-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Pelicans",
                "market": "New Orleans",
                "alias": "NOP"
            }, {
                "id": "583ecd4f-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Spurs",
                "market": "San Antonio",
                "alias": "SAS"
            }, {
                "id": "583ecf50-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Mavericks",
                "market": "Dallas",
                "alias": "DAL"
            }, {
                "id": "583ec825-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Warriors",
                "market": "Golden State",
                "alias": "GSW"
            }, {
                "id": "583ecae2-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Lakers",
                "market": "Los Angeles",
                "alias": "LAL"
            }, {
                "id": "583ecdfb-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Clippers",
                "market": "Los Angeles",
                "alias": "LAC"
            }, {
                "id": "583ecfa8-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Suns",
                "market": "Phoenix",
                "alias": "PHX"
            }, {
                "id": "583ed0ac-fb46-11e1-82cb-f4ce4684ea4c",
                "name": "Kings",
                "market": "Sacramento",
                "alias": "SAC"
            }]

Meteor.methods
  
  getNFLTeamMarketDictionary: (teamId) ->
    teamDictionary = {
      "TEN": {
        "id": "TEN",
        "name": "Titans",
        "market": "Tennessee",
        "full_name": "Tennessee Titans",
      },
      "BUF": {
        "id": "BUF",
        "name": "Bills",
        "market": "Buffalo",
        "full_name": "Buffalo Bills",
      },
      "MIA": {
        "id": "MIA",
        "name": "Dolphins",
        "market": "Miami",
        "full_name": "Miami Dolphins",
      },
      "NYJ": {
        "id": "NYJ",
        "name": "Jets",
        "market": "New York",
        "full_name": "New York Jets",
      },
      "NE": {
        "id": "NE",
        "name": "Patriots",
        "market": "New England",
        "full_name": "New England Patriots",
      },
      "CIN": {
        "id": "CIN",
        "name": "Bengals",
        "market": "Cincinnati",
        "full_name": "Cincinnati Bengals",
      },
      "CLE": {
        "id": "CLE",
        "name": "Browns",
        "market": "Cleveland",
        "full_name": "Cleveland Browns",
      },
      "BAL": {
        "id": "BAL",
        "name": "Ravens",
        "market": "Baltimore",
        "full_name": "Baltimore Ravens",
      },
      "PIT": {
        "id": "PIT",
        "name": "Steelers",
        "market": "Pittsburgh",
        "full_name": "Pittsburgh Steelers",
      },
      "IND": {
        "id": "IND",
        "name": "Colts",
        "market": "Indianapolis",
        "full_name": "Indianapolis Colts",
      },
      "JAC": {
        "id": "JAC",
        "name": "Jaguars",
        "market": "Jacksonville",
        "full_name": "Jacksonville Jaguars",
      },
      "HOU": {
        "id": "HOU",
        "name": "Texans",
        "market": "Houston",
        "full_name": "Houston Texans",
      },
      "DEN": {
        "id": "DEN",
        "name": "Broncos",
        "market": "Denver",
        "full_name": "Denver Broncos",
      },
      "SD": {
        "id": "SD",
        "name": "Chargers",
        "market": "San Diego",
        "full_name": "San Diego Chargers",
      },
      "KC": {
        "id": "KC",
        "name": "Chiefs",
        "market": "Kansas City",
        "full_name": "Kansas City Chiefs",
      },
      "OAK": {
        "id": "OAK",
        "name": "Raiders",
        "market": "Oakland",
        "full_name": "Oakland Raiders",
      },
      "DAL": {
        "id": "DAL",
        "name": "Cowboys",
        "market": "Dallas",
        "full_name": "Dallas Cowboys",
      },
      "PHI": {
        "id": "PHI",
        "name": "Eagles",
        "market": "Philadelphia",
        "full_name": "Philadelphia Eagles",
      },
      "NYG": {
        "id": "NYG",
        "name": "Giants",
        "market": "New",
        "full_name": "New York Giants",
      },
      "WAS": {
        "id": "WAS",
        "name": "Redskins",
        "market": "Washington",
        "full_name": "Washington Redskins",
      },
      "CHI": {
        "id": "CHI",
        "name": "Bears",
        "market": "Chicago",
        "full_name": "Chicago Bears",
      },
      "DET": {
        "id": "DET",
        "name": "Lions",
        "market": "Detroit",
        "full_name": "Detroit Lions",
      },
      "GB": {
        "id": "GB",
        "name": "Packers",
        "market": "Green Bay",
        "full_name": "Green Bay Packers",
      },
      "MIN": {
        "id": "MIN",
        "name": "Vikings",
        "market": "Minnesota",
        "full_name": "Minnesota Vikings",
      },
      "TB": {
        "id": "TB",
        "name": "Buccaneers",
        "market": "Tampa Bay",
        "full_name": "Tampa Bay Buccaneers",
      },
      "ATL": {
        "id": "ATL",
        "name": "Falcons",
        "market": "Atlanta",
        "full_name": "Atlanta Falcons",
      },
      "CAR": {
        "id": "CAR",
        "name": "Panthers",
        "market": "Carolina",
        "full_name": "Carolina Panthers",
      },
      "NO": {
        "id": "NO",
        "name": "Saints",
        "market": "New Orleans",
        "full_name": "New Orleans Saints",
      },
      "SF": {
        "id": "SF",
        "name": "49ers",
        "market": "San Francisco",
        "full_name": "San Francisco 49ers",
      },
      "ARI": {
        "id": "ARI",
        "name": "Cardinals",
        "market": "Arizona",
        "full_name": "Arizona Cardinals",
      },
      "STL": {
        "id": "STL",
        "name": "Rams",
        "market": "St. Louis",
        "full_name": "St. Louis Rams",
      },
      "SEA": {
        "id": "SEA",
        "name": "Seahawks",
        "market": "Seattle",
        "full_name": "Seattle Seahawks"
      }
    }

    return teamDictionary[teamId]

  # function getAthletesByTeamNFL
  #
  # This method adds the SD Player Id to the existing player's object.
  # This method initially was for adding Data to Seed Data
  # There are a few scenarios: 
  # 1) new player
  # 2) existing player, new information (team change, most likely)
  # 3) duplicate name, yet different player. (difficult, may need to add other identifer on there - jersey-team-last-name)
  # If the athlete doesn't exist yet, it adds them.
  #
  getAthletesByTeamNFL: (team) ->
    console.log '-------------  ' + team + ': UPDATING ROSTERS -------------'
    roster = JSON.parse(sd.NFLApi.getTeamRoster team)
    players = roster["players"]
    new_players = [] # for debugging and adding new ESPN images

    for player in players
      existingPlayer = NflPlayers.findOne({ "api.SDPlayerId": player.id }) # if player is in db
      if existingPlayer
        if !existingPlayer.api || !existingPlayer.api.SDPlayerId
          NflPlayers.update(
            { full_name: existingPlayer.full_name, team_id: roster.id }, # find player uniquely
            { $set: { 
                "api.SDPlayerId": player.id  # add the api id key to the player
                #
                # in case these changed, especially status... update them
                #
                position: player.position 
                jersey_number: player.jersey_number
                team: roster.market + ' ' + roster.name
                team_id: roster.id
                height: player.height
                weight: player.weight
                status: player.status
                salary: player.salary
                experience: player.experience
              }
            }
          )
          console.log 'API ID ADDED for' + player.name_full + ' ' + roster.market +  ' ' + player.position
        else
           NflPlayers.update(
            {"api.SDPlayerId": player.id}, 
            { $set: {
                position: player.position
                jersey_number: player.jersey_number
                team: roster.market + ' ' + roster.name
                team_id: roster.id
                status: player.status
                salary: player.salary
                experience: player.experience
              }
            }, 
            { multi: true }
          )
      else # if athlete doesn't exist, insert him
        NflPlayers.insert({
          full_name: player.name_full
          first_name: player.name_first
          last_name: player.name_last
          birthdate: player.birthdate
          height: player.height
          weight: player.weight
          college: player.college
          status: player.status
          salary: player.salary
          experience: player.experience
          jersey_number: player.jersey_number
          position: player.position
          team: roster.market + ' ' + roster.name
          team_id: roster.id
          api: {
            SDPlayerId: player.id
          }
        })
        
        #
        # DEBUGGING
        #
        new_players.push({name: player.name_full, api_id: player.id, team: roster.id})
    #
    # DEBUGGING
    #
    console.log 'NEW PLAYERS, ADD IMAGES TO:--------------------', new_players, " Total New Players", new_players.length

  addESPNId: (player) ->
    # ESPN Url regex for extracting ID
    # 
    regexp = new RegExp(/_\/id\/(\d+)/) # docs: http://www.w3schools.com/jsref/jsref_obj_regexp.asp
    existingPlayer = NflPlayers.findOne({ "full_name": player.name }) # if player is in db
    # Grab ESPN player ID from URL string
    id = regexp.exec(player.url)
    if id && existingPlayer
      NflPlayers.update(
        { full_name: existingPlayer.full_name, team: player.team.text }, # find player uniquely
        { $set: { 
            "espn_id": id[1] 
          }
        }
      )
    return false

  # Adds ESPN ID to player object, this powers the player image url
  #
  addESPNPlayerId: -> 
    # data via https://www.kimonolabs.com/apis/6dmp1l9s#data
    data = JSON.parse(Assets.getText("assets/nfl_player_data_espn_2015.json"))
    players = data.results.collection1
    for player in players
      Meteor.call 'addESPNId', player

  # One time seeding database action to Add all NFL Defenses to the NflPlayers collection
  # This is necessary since Defenses aren't scraped like players from the ESPN API
  #
  addNFLDefenses: ->
    for teamId in nflTeams
      teamDict = Meteor.call 'getNFLTeamMarketDictionary', teamId
      NflPlayers.insert(
        {
          "api": {
            "SDPlayerId": teamDict.id
          }
          "full_name": teamDict.full_name
          "status": "ACT"
          "position": "DEF"
          "team": teamDict.full_name
          "team_id": teamDict.id
          "salary": 4500
        }
      )
     
  #
  # Meteor.setInterval works, the code is cracked! 
  # docs: http://stackoverflow.com/questions/15229141/simple-timer-in-meteor-js
  # 
  updateAllTeamRostersNFL: ->
    i = 0
    len = nflTeams.length
    timer = Meteor.setInterval( ->
      if i >= len
        Meteor.clearInterval timer
      else
        Meteor.call 'getAthletesByTeamNFL', nflTeams[i]
        i++
    , 5000)

    return null


# UPDATE ROSTERS, GET ESPN IDS, AND ADD DEFENSEE
# Meteor.call 'updateAllTeamRostersNFL'
# Meteor.call 'addESPNPlayerId'

# One time database seeding all the NFL defenses - this should only happen once!
#
# Meteor.call 'addNFLDefenses'

# One off call for debugging
# Meteor.call 'getAthletesByTeamNFL', 'BAL'



#
#
# NBA METHODS
#
# 
# # @param alias [string] team abbreviation, ie. BOS
# # @return [string] team SD Id
# getTeamIdNBA: (alias) ->
#   for team in nbaTeams
#     if alias.toLowerCase() == team.alias.toLowerCase()
#       return team.id

# # Adds SDPlayerId to Athlete
# # 
# getAthletesByTeamNBA: (alias) ->
#   id = Meteor.call 'getTeamIdNBA', alias
#   roster = JSON.parse sd.NBAApi.getTeamProfile(id)
#   players = roster.players

#   for player in players
#     # IF PLAYER IS IN DB (TO ENRICH DATA WITH API.SDAPI)
#     # NOTE: search for combination of full_name, position and jersey_number?
#     existingPlayer = Athletes.findOne({ sport: 'NBA', full_name: player.full_name, jersey_number: parseInt(player.jersey_number) })
#     if existingPlayer # if existing, add the id to the player
#       if !existingPlayer.api || !existingPlayer.api.SDPlayerId
#         Athletes.update(
#           { _id: existingPlayer._id },
#           { $set: { 
#               "api.SDPlayerId": player.id 
#             }
#           }
#         )

# updateAllTeamRostersNBA: ->
#   i = 0
#   len = nbaTeams.length

#   timer = Meteor.setInterval( ->
#     if i is len
#       Meteor.clearInterval timer
#     else
#       Meteor.call 'getAthletesByTeamNBA', nbaTeams[i].alias
#       i++
#   , 2500)
# return null
      
# Meteor.call 'getAthletesByTeamNBA', 'BOS'
# Meteor.call 'updateAllTeamRostersNBA'
